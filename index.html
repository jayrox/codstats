<!DOCTYPE html>
<html lang="en">

<head>
    <title>COD Stats</title>
    <style>
        div#stats_container>div span {
            display: block;
        }
    </style>
</head>

<body>
    <button id="stats_refresh">Refresh</button>
    <input id="username" placeholder="Username" value="i am jayrox" />
    <select id="platform">
        <option selected platform="xbl">xbox</option>
        <option platform="psn">playstation</option>
        <option platform="battle">battle.net</option>
    </select>
    <div id="stats_container"></div>
    <div id="matches_container"></div>

    <script>
        const COD_API_ENDPOINT = 'https://my.callofduty.com/api/papi-client';
        const BO4_ENDPOINT = `${COD_API_ENDPOINT}/crm/cod/v2/title/bo4`;

        const request = async (uri) => {
            const response = await fetch(uri);
            console.log(uri, response.status);
            return await response.json();
        }

        const getRawMultiplayerStats = async (username, platform) => {
            const uri = `${BO4_ENDPOINT}/platform/${platform}/gamer/${encodeURI(username)}/profile?type=mp`;
            return await request(uri);
        }

        const getRawMultiplayerMatchesStats = async (username, platform, start = 0, end = 0) => {
            const startTimestamp = start !== 0 ? start.getTime() : 0;
            const endTimestamp = end !== 0 ? end.getTime() : 0;
            const uri = `${BO4_ENDPOINT}/platform/${platform}/gamer/${encodeURI(username)}/matches/mp/start/${startTimestamp}/end/${endTimestamp}/details`;
            return await request(uri);
        }

        const getPlatform = platform => {
            if (platform === 'xbl') return 'Xbox';
            if (platform === 'psn') return 'Playstation';
            if (platform === 'battle') return 'Battle.net';

            return '';
        }

        const genStats = (playerData) => {
            // Object.entries(playerData)
            //     .forEach(element => {
            //         console.log(element);
            //     });

            return `
                <div>
                    <span>Username: ${playerData.username}</span>
                    <span>Platform: ${getPlatform(playerData.platform)}</span>
                    <span>Level: ${playerData.mp.level}</span>
                    <span>Prestige: ${playerData.mp.prestige}</span>
                    <span>Kills: ${playerData.mp.weekly.all.kills}</span>
                    <span>Deaths: ${playerData.mp.weekly.all.deaths}</span>
                    <span>EKIA: ${playerData.mp.weekly.all.ekia}</span>
                    <span>Wins: ${playerData.mp.weekly.all.wins}</span>
                    <span>Losses: ${playerData.mp.weekly.all.losses}</span>
                </div>
                `;
        }

        const winningTeam = (score, team, winningTeam) => {
            if (team === winningTeam) return `<strong>${score}</strong>`;
            return score;
        }

        const genMatches = (matchesData) => {
            // Object.entries(matchesData)
            //     .forEach(element => {
            //         console.log(element);
            //     });

            return matchesData.matches.map(e => {
                return `
                    <div>
                        <span>Map: ${e.map}</span>
                        <span>Result: ${e.result} (${winningTeam(e.team1Score, '1', e.winningTeam)} - ${winningTeam(e.team2Score, '2', e.winningTeam)})</span>
                    </div>
                    `;
            })
            .join('\n');
        }

    </script>

    <script>
        document.querySelector('button#stats_refresh')
            .addEventListener('click', async event => {
                const username = document.querySelector('input#username').value;
                const platform = document.querySelector('select#platform option:checked')
                    .getAttribute('platform');

                const data = await getRawMultiplayerStats(username, platform);
                document.querySelector('div#stats_container').innerHTML = genStats(data.data);

                const d = await getRawMultiplayerMatchesStats(username, platform);
                document.querySelector('div#matches_container').innerHTML = genMatches(d.data);
            });
    </script>

</body>

</html>
